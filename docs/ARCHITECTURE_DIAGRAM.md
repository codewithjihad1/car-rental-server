# ğŸ“Š Server Architecture Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        CLIENT REQUESTS                           â”‚
â”‚                    (React Frontend App)                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         index.js                                 â”‚
â”‚                    (Main Entry Point)                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ â€¢ Express App Initialization                              â”‚  â”‚
â”‚  â”‚ â€¢ Middleware Setup (CORS, JSON)                          â”‚  â”‚
â”‚  â”‚ â€¢ Health Check Routes                                     â”‚  â”‚
â”‚  â”‚ â€¢ Error Handlers                                          â”‚  â”‚
â”‚  â”‚ â€¢ Graceful Shutdown                                       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚            â”‚           â”‚
         â”‚            â”‚           â”‚
         â–¼            â–¼           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   config/  â”‚  â”‚middlewareâ”‚  â”‚   routes/    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚            â”‚           â”‚
         â”‚            â”‚           â”‚
         â–¼            â–¼           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      CONFIG LAYER                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚  database.js         â”‚    â”‚  firebase.js         â”‚          â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤          â”‚
â”‚  â”‚ â€¢ connectDB()        â”‚    â”‚ â€¢ initializeFirebase â”‚          â”‚
â”‚  â”‚ â€¢ getDB()            â”‚    â”‚ â€¢ admin instance     â”‚          â”‚
â”‚  â”‚ â€¢ closeDB()          â”‚    â”‚                      â”‚          â”‚
â”‚  â”‚ â€¢ MongoDB Client     â”‚    â”‚                      â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    MIDDLEWARE LAYER                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                     auth.js                              â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚ â€¢ verifyFirebaseToken()                                  â”‚   â”‚
â”‚  â”‚   â””â”€> Validates JWT token from headers                  â”‚   â”‚
â”‚  â”‚                                                           â”‚   â”‚
â”‚  â”‚ â€¢ verifyTokenEmail()                                     â”‚   â”‚
â”‚  â”‚   â””â”€> Ensures email matches token                       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ROUTES LAYER                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚  carsRoutes.js       â”‚    â”‚ bookingsRoutes.js    â”‚          â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤          â”‚
â”‚  â”‚ GET  /all            â”‚    â”‚ GET  /               â”‚          â”‚
â”‚  â”‚ GET  /               â”‚    â”‚ GET  /count/:carId   â”‚          â”‚
â”‚  â”‚ GET  /recently-added â”‚    â”‚ POST /               â”‚          â”‚
â”‚  â”‚ GET  /available      â”‚    â”‚ PATCH /:id           â”‚          â”‚
â”‚  â”‚ GET  /search    â­   â”‚    â”‚                      â”‚          â”‚
â”‚  â”‚ GET  /:id            â”‚    â”‚                      â”‚          â”‚
â”‚  â”‚ POST /               â”‚    â”‚                      â”‚          â”‚
â”‚  â”‚ PUT  /:id            â”‚    â”‚                      â”‚          â”‚
â”‚  â”‚ DELETE /:id          â”‚    â”‚                      â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                           â”‚
            â–¼                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   CONTROLLERS LAYER                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚               carsController.js                           â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ â€¢ getAllCars()           â€¢ searchCars() â­               â”‚  â”‚
â”‚  â”‚ â€¢ getCarsByUserEmail()   â€¢ getCarById()                  â”‚  â”‚
â”‚  â”‚ â€¢ getRecentCars()        â€¢ createCar()                   â”‚  â”‚
â”‚  â”‚ â€¢ getAvailableCars()     â€¢ updateCar()                   â”‚  â”‚
â”‚  â”‚                          â€¢ deleteCar()                   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚             bookingsController.js                         â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ â€¢ getBookingsByUserEmail()                               â”‚  â”‚
â”‚  â”‚ â€¢ getBookingCountByCarId()                               â”‚  â”‚
â”‚  â”‚ â€¢ createBooking()                                        â”‚  â”‚
â”‚  â”‚ â€¢ updateBooking()                                        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      DATABASE LAYER                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                    MongoDB Atlas                          â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚  Database: car-rental                                     â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚  â”‚
â”‚  â”‚  â”‚ cars           â”‚         â”‚ bookings       â”‚          â”‚  â”‚
â”‚  â”‚  â”‚ collection     â”‚         â”‚ collection     â”‚          â”‚  â”‚
â”‚  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤          â”‚  â”‚
â”‚  â”‚  â”‚ â€¢ _id          â”‚         â”‚ â€¢ _id          â”‚          â”‚  â”‚
â”‚  â”‚  â”‚ â€¢ model        â”‚         â”‚ â€¢ carId        â”‚          â”‚  â”‚
â”‚  â”‚  â”‚ â€¢ brand        â”‚         â”‚ â€¢ userEmail    â”‚          â”‚  â”‚
â”‚  â”‚  â”‚ â€¢ price        â”‚         â”‚ â€¢ startDate    â”‚          â”‚  â”‚
â”‚  â”‚  â”‚ â€¢ transmission â”‚         â”‚ â€¢ endDate      â”‚          â”‚  â”‚
â”‚  â”‚  â”‚ â€¢ fuel         â”‚         â”‚ â€¢ status       â”‚          â”‚  â”‚
â”‚  â”‚  â”‚ â€¢ seats        â”‚         â”‚                â”‚          â”‚  â”‚
â”‚  â”‚  â”‚ â€¢ rating       â”‚         â”‚                â”‚          â”‚  â”‚
â”‚  â”‚  â”‚ â€¢ location     â”‚         â”‚                â”‚          â”‚  â”‚
â”‚  â”‚  â”‚ â€¢ ...          â”‚         â”‚                â”‚          â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ Request Flow Example

### Example: Advanced Car Search

```
1. CLIENT
   â†“
   GET /api/cars/search?query=sedan&minPrice=50&maxPrice=90
   â†“
2. index.js (Main Entry Point)
   â”œâ”€> Middleware: CORS âœ“
   â”œâ”€> Middleware: JSON Parser âœ“
   â””â”€> Route: /api/cars/search
   â†“
3. routes/carsRoutes.js
   â””â”€> router.get('/search', handler)
   â†“
4. controllers/carsController.js
   â””â”€> searchCars(req, res, carsCollection)
       â”œâ”€> Parse query parameters
       â”œâ”€> Build MongoDB filter
       â”‚   â”œâ”€> Text search: { $or: [...] }
       â”‚   â”œâ”€> Price filter: { price: { $gte, $lte } }
       â”‚   â”œâ”€> Transmission filter
       â”‚   â”œâ”€> Fuel filter
       â”‚   â””â”€> ...more filters
       â”œâ”€> Apply sorting
       â”œâ”€> Apply pagination
       â””â”€> Execute query
   â†“
5. config/database.js
   â””â”€> carsCollection.find(filter).sort().skip().limit()
   â†“
6. MongoDB Atlas
   â”œâ”€> Execute query with indexes
   â””â”€> Return matching documents
   â†“
7. RESPONSE
   {
     cars: [...],
     total: 45,
     totalPages: 4,
     currentPage: 1,
     limit: 12
   }
   â†“
8. CLIENT (receives data)
   â””â”€> React updates UI with TanStack Query
```

---

## ğŸ” Protected Route Flow

### Example: Get User's Cars

```
1. CLIENT
   â†“
   GET /api/cars?userEmail=user@example.com
   Headers: { Authorization: "Bearer <firebase-token>" }
   â†“
2. index.js
   â””â”€> Route: /api/cars
   â†“
3. routes/carsRoutes.js
   â””â”€> Middleware chain:
       [verifyFirebaseToken, verifyTokenEmail, handler]
   â†“
4. middleware/auth.js
   â”œâ”€> verifyFirebaseToken()
   â”‚   â”œâ”€> Extract token from header
   â”‚   â”œâ”€> Verify with Firebase Admin SDK
   â”‚   â”œâ”€> Decode token
   â”‚   â””â”€> Attach to req.decoded âœ“
   â”‚
   â””â”€> verifyTokenEmail()
       â”œâ”€> Extract email from query
       â”œâ”€> Compare with req.decoded.email
       â””â”€> Match? âœ“ Continue : âœ— 403 Forbidden
   â†“
5. controllers/carsController.js
   â””â”€> getCarsByUserEmail()
       â””â”€> Query cars by userEmail
   â†“
6. MongoDB
   â””â”€> Return user's cars
   â†“
7. CLIENT (receives protected data)
```

---

## ğŸ“¦ Module Dependencies

```
index.js
â”œâ”€â”€ requires config/database.js
â”‚   â””â”€â”€ exports: connectDB, getDB, closeDB
â”œâ”€â”€ requires config/firebase.js
â”‚   â””â”€â”€ exports: initializeFirebase, admin
â”œâ”€â”€ requires routes/carsRoutes.js
â”‚   â”œâ”€â”€ requires controllers/carsController.js
â”‚   â”‚   â””â”€â”€ exports: 9 functions
â”‚   â””â”€â”€ requires middleware/auth.js
â”‚       â””â”€â”€ exports: verifyFirebaseToken, verifyTokenEmail
â””â”€â”€ requires routes/bookingsRoutes.js
    â”œâ”€â”€ requires controllers/bookingsController.js
    â”‚   â””â”€â”€ exports: 4 functions
    â””â”€â”€ requires middleware/auth.js
        â””â”€â”€ exports: verifyFirebaseToken, verifyTokenEmail
```

---

## ğŸ¯ Architecture Benefits

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         SOLID PRINCIPLES                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âœ… Single Responsibility                â”‚
â”‚    Each module has one job              â”‚
â”‚                                         â”‚
â”‚ âœ… Open/Closed Principle                â”‚
â”‚    Easy to extend, hard to break       â”‚
â”‚                                         â”‚
â”‚ âœ… Dependency Inversion                 â”‚
â”‚    Controllers depend on abstractions  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      CLEAN ARCHITECTURE                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Layer 1: Routes (HTTP interface)        â”‚
â”‚ Layer 2: Controllers (Business logic)   â”‚
â”‚ Layer 3: Services (Data access)         â”‚
â”‚ Layer 4: Database (Persistence)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸš€ Performance Flow

```
Request â†’ Middleware (fast) â†’ Route (instant) â†’ Controller (logic) â†’ Database (indexed) â†’ Response
   â†“           â†“                   â†“                â†“                    â†“              â†“
  CORS      Auth Check         Parsing         Business Logic      MongoDB Query    JSON
  JSON       Token              Route           Filtering           Indexed Lookup   Format
             Verify             Matching        Sorting             Efficient        Send
```

**Optimizations:**

-   âœ… Single database connection (reused)
-   âœ… Middleware runs once per request
-   âœ… Controllers are stateless (fast)
-   âœ… Database indexes for quick lookups
-   âœ… Efficient error handling

---

## ğŸ“ File System View

```
server-side/
â”‚
â”œâ”€â”€ ğŸ“‚ config/               (Configuration)
â”‚   â”œâ”€â”€ ğŸ“„ database.js       MongoDB setup
â”‚   â””â”€â”€ ğŸ“„ firebase.js       Firebase setup
â”‚
â”œâ”€â”€ ğŸ“‚ controllers/          (Business Logic)
â”‚   â”œâ”€â”€ ğŸ“„ carsController.js       9 functions
â”‚   â””â”€â”€ ğŸ“„ bookingsController.js   4 functions
â”‚
â”œâ”€â”€ ğŸ“‚ middleware/           (Request Processing)
â”‚   â””â”€â”€ ğŸ“„ auth.js           Authentication
â”‚
â”œâ”€â”€ ğŸ“‚ routes/               (API Endpoints)
â”‚   â”œâ”€â”€ ğŸ“„ carsRoutes.js     9 endpoints
â”‚   â””â”€â”€ ğŸ“„ bookingsRoutes.js 4 endpoints
â”‚
â”œâ”€â”€ ğŸ“„ index.js              (Entry Point - 104 lines)
â”œâ”€â”€ ğŸ“„ index.backup.js       (Original - 412 lines)
â”‚
â”œâ”€â”€ ğŸ“„ advancedSearchExample.js
â”œâ”€â”€ ğŸ“„ sampleData.js
â”œâ”€â”€ ğŸ“„ firebase-adminsdk.json
â”‚
â”œâ”€â”€ ğŸ“˜ SERVER_STRUCTURE.md
â”œâ”€â”€ ğŸ“˜ RESTRUCTURING_SUMMARY.md
â”œâ”€â”€ ğŸ“˜ ARCHITECTURE_DIAGRAM.md (this file)
â”‚
â”œâ”€â”€ ğŸ“¦ package.json
â””â”€â”€ ğŸ”’ .env
```

---

**This modular architecture makes your server maintainable, scalable, and production-ready!** âœ¨
